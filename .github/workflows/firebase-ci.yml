# ==============================================================================
# !! PARE E LEIA: AÇÃO NECESSÁRIA PARA CORRIGIR O ERRO DE DEPLOY !!
# ==============================================================================
# O erro "Input required and not supplied: firebaseServiceAccount" que está
# acontecendo repetidamente NÃO é um problema no código da aplicação.
# O problema é que o GitHub Actions não está encontrando a chave secreta
# necessária para se autenticar no Firebase.
#
# Para resolver isso PERMANENTEMENTE, siga os passos abaixo CUIDADOSAMENTE:
#
# 1.  VÁ PARA SEU REPOSITÓRIO NO GITHUB.
#
# 2.  CLIQUE EM "SETTINGS" (CONFIGURAÇÕES) no topo da página.
#
# 3.  NO MENU ESQUERDO, CLIQUE EM "SECRETS AND VARIABLES" E DEPOIS EM "ACTIONS".
#
# 4.  VERIFIQUE SE EXISTE UM SEGREDO CHAMADO `FIREBASE_SERVICE_ACCOUNT`.
#     - Se existir, delete-o. Vamos criar um novo para garantir que está correto.
#
# 5.  CLIQUE NO BOTÃO "NEW REPOSITORY SECRET".
#
# 6.  NO CAMPO "NAME", DIGITE EXATAMENTE:
#     FIREBASE_SERVICE_ACCOUNT
#
# 7.  NO CAMPO "SECRET", VOCÊ PRECISA COLAR O CONTEÚDO INTEIRO DO ARQUIVO JSON
#     DA SUA CONTA DE SERVIÇO DO FIREBASE.
#     - Para obter este arquivo:
#       a. Abra seu projeto no Console do Firebase (https://console.firebase.google.com/).
#       b. Clique na engrenagem ao lado de "Project Overview" e selecione "Project settings".
#       c. Vá para a aba "Service accounts".
#       d. Clique em "Generate new private key" e confirme.
#       e. Um arquivo .json será baixado. Abra-o com um editor de texto.
#       f. Copie TODO o conteúdo do arquivo (desde o `{` inicial até o `}` final).
#       g. Cole esse conteúdo no campo "Secret" do GitHub.
#
# 8.  CLIQUE EM "ADD SECRET".
#
# Após seguir estes passos, o próximo deploy deverá funcionar.
# ==============================================================================

name: Build, Test and Deploy to Firebase

on:
  push:
    branches:
      - main # Aciona em pushes para a branch principal
  pull_request:
    branches:
      - main # Aciona em pull requests para a branch principal

jobs:
  build_and_test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'functions/package.json'

      - name: Install Functions Dependencies
        # Usa 'npm install' como fallback para ambientes sem package-lock.json
        run: npm install --prefix functions

      - name: Audit for Security Vulnerabilities
        run: npm audit --prefix functions --audit-level=high

      - name: Run Backend Tests
        run: npm test --prefix functions

  deploy:
    name: Deploy to Firebase
    needs: build_and_test # Depende do sucesso do job 'build_and_test'
    runs-on: ubuntu-latest
    # Apenas executa este job em pushes para a branch 'main', não em pull requests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # A ação `action-hosting-deploy` lida com o deploy de Functions e Hosting.
      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: gemini-cli-98f4a
