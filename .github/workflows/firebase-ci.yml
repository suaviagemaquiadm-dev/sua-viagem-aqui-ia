# ##############################################################################
# ##############################################################################
# ###                                                                        ###
# ###      ATENÇÃO: AÇÃO MANUAL NECESSÁRIA PARA CORRIGIR O DEPLOY!           ###
# ###                                                                        ###
# ##############################################################################
# ##############################################################################
#
# O erro de deploy ("Input required and not supplied: firebaseServiceAccount")
# que está acontecendo NÃO é um erro de CÓDIGO. É um erro de CONFIGURAÇÃO
# no seu repositório do GitHub.
#
# SIGA ESTES PASSOS EXATAMENTE COMO DESCRITO:
#
# --- PASSO 1: VÁ PARA AS CONFIGURAÇÕES DO SEU REPOSITÓRIO GITHUB ---
#    - Vá para a página principal do seu repositório.
#    - Clique em "Settings" (ícone de engrenagem).
#    - No menu à esquerda, clique em "Secrets and variables" -> "Actions".
#
# --- PASSO 2: APAGUE O SEGREDO ANTIGO (SE EXISTIR) ---
#    - Na lista de "Repository secrets", procure por "FIREBASE_SERVICE_ACCOUNT".
#    - Se encontrar, clique em "Remove" ou no ícone de lixeira para apagá-lo.
#      É importante começar do zero para garantir que está correto.
#
# --- PASSO 3: CRIE UM NOVO SEGREDO ---
#    - Clique no botão "New repository secret".
#    - No campo "Name", cole EXATAMENTE o seguinte nome:
#
#      FIREBASE_SERVICE_ACCOUNT
#
# --- PASSO 4: OBTENHA E COLE O VALOR DO SEGREDO ---
#    - O valor é o CONTEÚDO COMPLETO do seu arquivo JSON da conta de serviço do Firebase.
#    - Para obter este arquivo:
#      1. Abra seu projeto no Console do Firebase: https://console.firebase.google.com/
#      2. Clique na engrenagem (Configurações do projeto).
#      3. Vá para a aba "Contas de serviço" (Service accounts).
#      4. Clique no botão "Gerar nova chave privada" (Generate new private key).
#      5. Um arquivo .json será baixado. Abra-o com um editor de texto simples (Bloco de Notas, VS Code, etc.).
#      6. COPIE TUDO, desde o primeiro `{` até o último `}`.
#      7. VOLTE PARA O GITHUB e COLE este conteúdo no campo "Secret".
#
# --- PASSO 5: SALVE O SEGREDO ---
#    - Clique em "Add secret".
#
# ##############################################################################
# ###                  TROUBLESHOOTING / ERROS COMUNS                        ###
# ##############################################################################
#
# - NOME INCORRETO: O nome DEVE SER `FIREBASE_SERVICE_ACCOUNT`, sem espaços, tudo maiúsculo.
# - VALOR INCOMPLETO: Você precisa copiar o arquivo JSON INTEIRO.
# - VARIÁVEL VS. SEGREDO: Certifique-se de que você está criando um "Secret", não uma "Variable".
# - REPOSITÓRIO ERRADO: Garanta que você está nas configurações do repositório correto.
#
# ##############################################################################

name: Build, Test and Deploy to Firebase

on:
  push:
    branches:
      - main # Aciona em pushes para a branch principal
  pull_request:
    branches:
      - main # Aciona em pull requests para a branch principal

jobs:
  build_and_test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'functions/package.json'

      - name: Install Functions Dependencies
        # Usa 'npm install' como fallback para ambientes sem package-lock.json
        run: npm install --prefix functions

      - name: Audit for Security Vulnerabilities
        run: npm audit --prefix functions --audit-level=high

      - name: Run Backend Tests
        run: npm test --prefix functions

  deploy:
    name: Deploy to Firebase
    needs: build_and_test # Depende do sucesso do job 'build_and_test'
    runs-on: ubuntu-latest
    # Apenas executa este job em pushes para a branch 'main', não em pull requests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Firebase Service Account Secret
        env:
          FIREBASE_SA_SECRET: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          if [ -z "$FIREBASE_SA_SECRET" ]; then
            echo "===================================================================="
            echo "====== ERRO CRÍTICO: SEGREDOS DO GITHUB NÃO CONFIGURADOS ======"
            echo "===================================================================="
            echo ""
            echo "O segredo 'FIREBASE_SERVICE_ACCOUNT' não foi encontrado."
            echo "Isto NÃO é um erro no código. Você precisa configurar os segredos"
            echo "nas configurações do seu repositório no GitHub."
            echo ""
            echo "=> POR FAVOR, SIGA AS INSTRUÇÕES NO TOPO DESTE ARQUIVO"
            echo "   ('.github/workflows/firebase-ci.yml') PARA RESOLVER."
            echo ""
            echo "===================================================================="
            exit 1
          fi

      # A ação `action-hosting-deploy` lida com o deploy de Functions e Hosting.
      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: gemini-cli-98f4a
